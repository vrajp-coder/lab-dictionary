<!-- Settings tab -->
<div class="page-container" style="max-width:900px;">
  <h4 style="text-align:center;">Settings</h4>

  <!-- dropdown row -->
  <div class="flex-row" style="gap:40px;">
    <div style="flex:1;">
      <label><strong>Select department type:</strong></label>
      <div class="search-container">
        <input type="text" id="dept-search" class="form-control" placeholder="Search…">
      </div>
      <div class="dropdown-panel" id="dept-panel"></div>
    </div>

    <div style="flex:1;">
      <label><strong>Select encounter type:</strong></label>
      <div class="search-container">
        <input type="text" id="enc-search" class="form-control" placeholder="Search…">
      </div>
      <div class="dropdown-panel" id="enc-panel"></div>
    </div>
  </div>

  <!-- numeric + date inputs -->
  <div style="margin-top:25px;">
    <div class="flex-row" style="gap:20px;">
      <div class="flex-fill">
        <label class="form-label">Minimum age</label>
        <input type="number" id="age-min" class="form-control" min="0">
      </div>
      <div class="flex-fill">
        <label class="form-label">Maximum age</label>
        <input type="number" id="age-max" class="form-control" min="0">
      </div>
    </div>

    <div class="flex-row" style="gap:20px; margin-top:15px;">
      <div class="flex-fill">
        <label class="form-label">Visit start date</label>
        <input type="date" id="start-date" class="form-control">
      </div>
      <div class="flex-fill">
        <label class="form-label">Visit end date</label>
        <input type="date" id="end-date" class="form-control">
      </div>
    </div>

    <div style="margin-top:15px;">
      <label class="form-label">Detailed mode</label>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="detailed-switch" disabled>
        <label class="form-check-label" for="detailed-switch">Off</label>
      </div>
    </div>
  </div>

  <button class="btn btn-success w-100" id="settingsSubmit" style="margin-top:25px;">Submit</button>
  <div id="settings-msg" style="margin-top:10px;"></div>
</div>

<script>
/* --- fetch choices --- */
let deptChoices = [], encChoices = [];
let deptSel = new Set(), encSel = new Set();

const deptPanel = document.getElementById("dept-panel");
const encPanel  = document.getElementById("enc-panel");

function renderPanel(panel, choices, sel, search){
  panel.innerHTML = "";
  let shown = 0;
  choices.forEach(txt=>{
    if (search && !txt.toLowerCase().includes(search)) return;
    shown++;
    const di = document.createElement("div");
    di.textContent = txt;
    di.classList.add("dropdown-item");
    if (sel.has(txt)) di.classList.add("selected");
    di.addEventListener("click", e=>{
      const multi = e.ctrlKey || e.metaKey;
      if(!multi) sel.add(txt);
      else sel.has(txt) ? sel.delete(txt) : sel.add(txt);
      renderPanel(panel, choices, sel, document.getElementById(
        panel===deptPanel ? "dept-search" : "enc-search").value.toLowerCase());
    });
    panel.appendChild(di);
  });
  /* <-- make the panel visible or hide if empty */
  panel.style.display = shown ? "block" : "none";
}

fetch("/get_department_choices/").then(r=>r.json()).then(j=>{
  deptChoices = j.choices||[]; renderPanel(deptPanel, deptChoices, deptSel, "");
});
fetch("/get_encounter_choices/").then(r=>r.json()).then(j=>{
  encChoices = j.choices||[];  renderPanel(encPanel,  encChoices,  encSel,  "");
});

document.getElementById("dept-search").addEventListener("input", e=>{
  renderPanel(deptPanel, deptChoices, deptSel, e.target.value.toLowerCase());
});
document.getElementById("enc-search").addEventListener("input", e=>{
  renderPanel(encPanel, encChoices, encSel, e.target.value.toLowerCase());
});

/* ---- submit → build settings object & expose globally ---- */
const msgEl = document.getElementById("settings-msg");
document.getElementById("settingsSubmit").addEventListener("click", ()=>{
  if(!deptSel.size && !encSel.size){
    msgEl.innerHTML = "<span style='color:#dc3545;'>Please select at least one department OR encounter type.</span>";
    return;
  }
  const obj = {
    age_min : document.getElementById("age-min").value || "",
    age_max : document.getElementById("age-max").value || "",
    department_types : Array.from(deptSel),
    encounter_types  : Array.from(encSel),
    visit_start_date : document.getElementById("start-date").value,
    visit_end_date   : document.getElementById("end-date").value,
    detailed_mode    : false
  };
  window.settingsForEmail = obj;                // <‑‑ make globally visible
  msgEl.style.color = "#4caf50";
  msgEl.textContent = "Your settings have been submitted!";
});
</script>
